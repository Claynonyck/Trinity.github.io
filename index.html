<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Trinity - Tr√¨nh ph√°t nh·∫°c Cloud Persistence</title>
    <style>
        :root{
            --bg:#121212;--panel:#181818;--muted:#9a9a9a;--accent:#1db954;--card:#1e1e1e;--warning:#ffcc00
        }
        *{box-sizing:border-box}
        html,body{height:100%;margin:0;font-family:Inter,Arial,Helvetica,sans-serif;background:var(--bg);color:#eee}

        .app{display:flex;height:100vh;}
        .sidebar{width:240px;background:#0f0f0f;padding:22px;border-right:1px solid #222;display:flex;flex-direction:column}
        .brand{font-weight:700;font-size:18px;margin-bottom:18px;color:var(--accent)}
        .nav{display:flex;flex-direction:column;gap:8px}
        .nav button{background:transparent;border:none;color:#ddd;text-align:left;padding:10px;border-radius:8px;cursor:pointer;font-size:15px}
        .nav button.active{background:#171717}

        .library-box{margin-top:18px;padding-top:12px;border-top:1px solid #212121}
        .upload-label{display:inline-block;padding:10px 12px;background:#111;border-radius:10px;cursor:pointer;border:1px dashed #2a2a2a; transition: all 0.2s;}
        .upload-label:hover{border-color:var(--accent); background: #1a1a1a;}
        .upload-input{display:none}
        .library-list{margin-top:12px;max-height:38vh;overflow:auto;padding:0;list-style:none}
        .library-list li{padding:8px;border-radius:8px;background:#121212;margin-bottom:8px;border:1px solid #222;cursor:pointer; transition: background 0.2s;}
        .library-list li:hover{background:#1a1a1a;}
        .library-list li small{display:block;font-size:12px}
        .library-list li.local-missing small{color: var(--warning); font-weight: 500;}
        .library-list li small.local-ok{color:var(--muted);}

        .main{flex:1;display:flex;flex-direction:column}
        .topbar{padding:18px 24px;border-bottom:1px solid #242424;display:flex;justify-content:space-between;align-items:center}
        .title{font-size:20px}
        .auth-info{font-size:12px; color: var(--muted); padding-right: 10px;}

        .content{flex:1;overflow:auto;padding:22px}

        .playlist{max-width:900px;margin:0 auto;display:flex;flex-direction:column;gap:12px}
        .track{display:flex;justify-content:space-between;align-items:center;padding:12px;border-radius:10px;background:var(--card);border:1px solid #252525; cursor:pointer; transition: background 0.2s;}
        .track:hover{background: #252525;}
        .track .meta{display:flex;gap:12px;align-items:center}
        .track .meta .thumb{width:48px;height:48px;border-radius:6px;background:linear-gradient(135deg,#222,#111);display:flex;align-items:center;justify-content:center;color:var(--muted)}
        .track .meta .info{display:flex;flex-direction:column}
        .track .meta .info .name{font-weight:600}
        .track .meta .info .artist{font-size:13px;color:var(--muted)}
        .track.active{outline:2px solid var(--accent); background: #222222;}
        .track.unplayable{opacity: 0.6; cursor: not-allowed; outline: 1px dashed var(--warning);}

        .volume{width:120px;}
        .player-bar{height:110px;background:var(--panel);border-top:1px solid #252525;padding:14px 22px;display:flex;align-items:center;gap:18px}
        .player-cover{width:70px;height:70px;border-radius:8px;background:#161616;display:flex;align-items:center;justify-content:center}
        .player-controls{flex:1}
        .controls{display:flex;align-items:center;gap:14px;margin-bottom:8px}
        .controls button{background:transparent;border:none;color:#ddd;font-size:24px;cursor:pointer; transition: color 0.2s; padding: 4px; border-radius: 4px;}
        .controls button:hover{color: var(--accent);}
        .seek{width:100%; height: 6px; cursor: pointer;}
        .small-muted{color:var(--muted);font-size:13px}

        .library-main{max-width:900px;margin:0 auto}
        .library-grid{display:flex;flex-direction:column;gap:10px;margin-top:12px}
        .file-row{display:flex;justify-content:space-between;align-items:center;padding:12px;border-radius:10px;background:#151515;border:1px solid #232323}
        .btn{padding:8px 12px;border-radius:8px;border:none;cursor:pointer;font-weight: 500;}
        .btn.ghost{background:transparent;border:1px solid #333;color:#ddd; transition: all 0.2s;}
        .btn.ghost:hover{background: #333;}
        .btn.primary{background:var(--accent);color:#061d0d; transition: all 0.2s;}
        .btn.primary:hover{background: #159544;}
        .btn.danger{background: #b91d1d; color: white;}
        .btn:disabled{opacity: 0.5; cursor: not-allowed;}

        .status-box{
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 20px 30px;
            border-radius: 12px;
            z-index: 1000;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid var(--accent);
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin-bottom: 10px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media(max-width:880px){
            .sidebar{display:none}
            .app{flex-direction:column}
            .player-bar{height:90px; padding: 10px 15px;}
            .player-cover{width: 50px; height: 50px;}
            .auth-info{display: none;}
            .volume{display: none;}
            .controls{gap: 10px;}
            .controls button{font-size: 20px;}
        }
    </style>
</head>
<body>
    <div class="app">
        <aside class="sidebar">
            <div class="brand">üéß MusicApp (Cloud)</div>
            <nav class="nav">
                <button id="navHome" class="active">Playlist (C√¥ng c·ªông)</button>
                <button id="navLibrary">Th∆∞ vi·ªán (Qu·∫£n l√Ω File)</button>
            </nav>

            <div class="library-box">
                <label class="upload-label">T·∫£i file m·ªõi (L∆∞u Cloud Metadata C√¥ng c·ªông & Local File)
                    <input id="sidebarUpload" class="upload-input" type="file" accept="audio/*" multiple />
                </label>
                <ul id="sidebarList" class="library-list"></ul>
            </div>
            
            <div style="margin-top: auto; padding-top: 15px; border-top: 1px solid #212121;">
                 <div id="authUserId" class="small-muted" style="word-break: break-all;"></div>
            </div>
        </aside>

        <main class="main">
            <div class="topbar">
                <div class="title">Home</div>
                <div id="authStatus" class="auth-info">ƒêang k·∫øt n·ªëi...</div>
            </div>

            <div class="content">
                <section id="homeView" class="home-view">
                    <h2>Danh s√°ch b√†i h√°t ƒë∆∞·ª£c chia s·∫ª c√¥ng c·ªông (Public Playlist)</h2>
                    <div class="small-muted" style="color: var(--warning);">
                        L∆ØU √ù QUAN TR·ªåNG: ƒê√¢y l√† danh s√°ch c√¥ng c·ªông. File nh·∫°c th·ª±c t·∫ø (Blob) ch·ªâ ƒë∆∞·ª£c l∆∞u c·ª•c b·ªô (IndexedDB) tr√™n thi·∫øt b·ªã c·ªßa ng∆∞·ªùi t·∫£i l√™n. B·∫°n ch·ªâ c√≥ th·ªÉ ph√°t c√°c b√†i h√°t c√≥ d·∫•u "ƒê√É C√ì FILE C·ª§C B·ªò".
                    </div>
                    <div class="playlist" id="playlistContainer">
                        <div class="small-muted" id="loadingIndicatorHome">ƒêang ch·ªù x√°c th·ª±c Firebase...</div>
                    </div>
                </section>

                <section id="libraryView" class="library-main" style="display:none">
                    <h3>Qu·∫£n l√Ω Th∆∞ vi·ªán - Metadata ƒë∆∞·ª£c l∆∞u tr√™n Cloud (C√¥ng c·ªông)</h3>
                    <div style="margin-top:14px">
                        <label class="upload-label">T·∫£i file m·ªõi<input id="libUploadMain" class="upload-input" type="file" accept="audio/*" multiple /></label>
                    </div>
                    <div class="library-grid" id="libraryGrid"></div>
                </section>
            </div>

            <div class="player-bar">
                <div class="player-cover" id="playerCover">‚ô™</div>
                <div class="player-controls">
                    <div class="controls">
                        <input id="volume" class="volume" type="range" min="0" max="1" step="0.01" value="1">
                        <button id="prevBtn" title="Previous">‚èÆ</button>
                        <button id="playBtn" title="Play/Pause">‚ñ∂</button>
                        <button id="nextBtn" title="Next">‚è≠</button>
                        <button id="repeatBtn" title="Repeat Playlist">üîÅ</button>
                        <div id="currentTitle" style="margin-left:10px;font-weight:600">Kh√¥ng c√≥ b√†i</div>
                    </div>
                    <input id="seek" class="seek" type="range" min="0" max="100" value="0">
                    <div style="display:flex;justify-content:space-between;margin-top:6px"><span id="timeLeft" class="small-muted">0:00</span><span id="timeRight" class="small-muted">0:00</span></div>
                </div>
                <audio id="audioPlayer" preload="metadata" style="display:none"></audio>
            </div>
        </main>
    </div>

    <div id="statusBox" class="status-box">
        <div class="spinner"></div>
        <div id="statusText">ƒêang x·ª≠ l√Ω...</div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, collection, addDoc, setDoc, deleteDoc, onSnapshot, query, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase Globals and Setup ---
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-music-app-id';

        let app;
        let db;
        let auth;
        let userId = null;
        let isAuthReady = false;

        if (Object.keys(firebaseConfig).length > 0) {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
        } else {
            console.error("Firebase config is missing. Application will run in read-only mode.");
        }

        // New public collection path for shared metadata
        const PUBLIC_SONGS_COLLECTION_PATH = `artifacts/${appId}/public/data/songs_public`;
        const getSongsCollectionPath = () => PUBLIC_SONGS_COLLECTION_PATH;

        // --- IndexedDB Globals for Local Blobs ---
        const LOCAL_DB_NAME = 'MusicPlayerBlobCache';
        const LOCAL_DB_VERSION = 1;
        const LOCAL_STORE_NAME = 'songs_blob';
        let localDB = null;

        // --- App State ---
        let songs = []; // Combined: Firestore Metadata + IndexedDB Blob
        let currentIndex = -1;
        let repeat = false;
        let currentObjectURL = null;

        // --- Elements ---
        const navHome = document.getElementById('navHome');
        const navLibrary = document.getElementById('navLibrary');
        const homeView = document.getElementById('homeView');
        const libraryView = document.getElementById('libraryView');
        const sidebarUpload = document.getElementById('sidebarUpload');
        const sidebarList = document.getElementById('sidebarList');
        const libUploadMain = document.getElementById('libUploadMain');
        const libraryGrid = document.getElementById('libraryGrid');
        const playlistContainer = document.getElementById('playlistContainer');
        const loadingIndicatorHome = document.getElementById('loadingIndicatorHome');
        const authUserId = document.getElementById('authUserId');
        const authStatus = document.getElementById('authStatus');
        
        const audio = document.getElementById('audioPlayer');
        const playBtn = document.getElementById('playBtn');
        const prevBtn = document.getElementById('prevBtn');
        const nextBtn = document.getElementById('nextBtn');
        const repeatBtn = document.getElementById('repeatBtn');
        const currentTitle = document.getElementById('currentTitle');
        const seek = document.getElementById('seek');
        const timeLeft = document.getElementById('timeLeft');
        const timeRight = document.getElementById('timeRight');
        const statusBox = document.getElementById('statusBox');
        const statusText = document.getElementById('statusText');
        const volume = document.getElementById('volume');

        // --- Utility Functions ---

        function fmt(s){
            if(isNaN(s) || s < 0) return '0:00';
            const m = Math.floor(s/60); 
            const sec = Math.floor(s%60).toString().padStart(2,'0');
            return m+':'+sec;
        }

        function showStatus(text, show) {
            statusText.innerText = text;
            statusBox.style.display = show ? 'flex' : 'none';
        }

        function getAudioDuration(file) {
            return new Promise((resolve, reject) => {
                const tempAudio = document.createElement('audio');
                tempAudio.preload = 'metadata';
                const tempURL = URL.createObjectURL(file);
                
                tempAudio.onloadedmetadata = () => {
                    resolve(tempAudio.duration);
                    URL.revokeObjectURL(tempURL);
                };
                tempAudio.onerror = (e) => {
                    console.error("Failed to load audio metadata.", e);
                    URL.revokeObjectURL(tempURL);
                    resolve(0);
                };
                tempAudio.src = tempURL;
            });
        }
        
        // --- IndexedDB (Local Blob Cache) Functions ---

        function openLocalDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(LOCAL_DB_NAME, LOCAL_DB_VERSION);

                request.onupgradeneeded = (event) => {
                    localDB = event.target.result;
                    if (!localDB.objectStoreNames.contains(LOCAL_STORE_NAME)) {
                        localDB.createObjectStore(LOCAL_STORE_NAME, { keyPath: 'id' });
                    }
                };

                request.onsuccess = (event) => {
                    localDB = event.target.result;
                    resolve(localDB);
                };

                request.onerror = (event) => {
                    console.error("IndexedDB Error:", event.target.error);
                    reject(new Error("Failed to open IndexedDB"));
                };
            });
        }

        function saveBlobToLocalDB(id, fileBlob) {
            return new Promise((resolve, reject) => {
                if (!localDB) return reject(new Error("Local DB not ready"));
                const transaction = localDB.transaction([LOCAL_STORE_NAME], 'readwrite');
                const store = transaction.objectStore(LOCAL_STORE_NAME);
                
                const request = store.put({ id: id, file: fileBlob });

                request.onsuccess = () => resolve();
                request.onerror = (event) => reject(new Error("Failed to save blob locally"));
            });
        }
        
        function getBlobFromLocalDB(id) {
             return new Promise((resolve, reject) => {
                if (!localDB) return resolve(null);
                const transaction = localDB.transaction([LOCAL_STORE_NAME], 'readonly');
                const store = transaction.objectStore(LOCAL_STORE_NAME);
                
                const request = store.get(id);

                request.onsuccess = (event) => {
                    resolve(event.target.result ? event.target.result.file : null);
                };
                request.onerror = (event) => reject(new Error("Failed to get blob locally"));
            });
        }

        function deleteBlobFromLocalDB(id) {
             return new Promise((resolve, reject) => {
                if (!localDB) return resolve();
                const transaction = localDB.transaction([LOCAL_STORE_NAME], 'readwrite');
                const store = transaction.objectStore(LOCAL_STORE_NAME);
                
                const request = store.delete(id);

                request.onsuccess = () => resolve();
                request.onerror = (event) => reject(new Error("Failed to delete blob locally"));
            });
        }

        // --- Firestore (Cloud Metadata) Functions ---

        async function saveSongMetadataToCloud(metadata) {
            if (!userId) throw new Error("User not authenticated for saving data.");
            // Use public collection path
            const songsRef = collection(db, getSongsCollectionPath()); 
            
            // Set doc with the song's ID as the document ID
            await setDoc(doc(songsRef, metadata.id), {
                id: metadata.id,
                name: metadata.name,
                artist: metadata.artist,
                duration: metadata.duration,
                timestamp: Date.now(),
                uploaderId: userId // Store the user ID for attribution
            });
        }

        async function deleteSongMetadataFromCloud(id) {
            if (!userId) throw new Error("User not authenticated for deleting data.");
            // Use public collection path
            const docRef = doc(db, getSongsCollectionPath(), id);
            await deleteDoc(docRef);
        }
        
        function setupFirestoreListener() {
            if (!isAuthReady) return; // Only need to check if Firebase is ready
            
            loadingIndicatorHome.innerText = 'ƒêang t·∫£i danh s√°ch b√†i h√°t c√¥ng c·ªông t·ª´ Cloud...';
            
            // Query public collection
            const q = query(collection(db, getSongsCollectionPath())); 
            
            onSnapshot(q, async (snapshot) => {
                loadingIndicatorHome.style.display = 'none';
                
                const cloudMetadata = snapshot.docs.map(d => d.data());
                
                // Fetch local blobs and combine with cloud metadata
                const combinedSongs = [];
                for (const meta of cloudMetadata) {
                    const fileBlob = await getBlobFromLocalDB(meta.id);
                    // Add the file to the song object if available locally
                    combinedSongs.push({
                        ...meta,
                        file: fileBlob 
                    });
                }
                
                songs = combinedSongs;
                
                renderLibrary();
                renderSidebarList();
                renderPlaylist();
                
                // If the currently playing song was deleted or index changed, update the player state
                if (currentIndex !== -1 && (!songs[currentIndex] || songs[currentIndex].id !== songs[currentIndex].id)) {
                    if (songs.length > 0) {
                        loadSong(0);
                        audio.pause();
                    } else {
                        loadSong(-1);
                    }
                }
            }, (error) => {
                console.error("Firestore Listener Error:", error);
                authStatus.innerText = 'L·ªói ƒë·ªìng b·ªô Cloud.';
            });
        }

        // --- File Management & Upload ---

        async function handleFiles(fileList){
            if (!userId) {
                console.error("Authentication not ready. Cannot upload.");
                showStatus("Ch∆∞a x√°c th·ª±c. Vui l√≤ng ƒë·ª£i...", false);
                return;
            }
            if (fileList.length === 0) return;

            loadingIndicatorHome.style.display = 'none';

            for(const file of fileList){
                showStatus(`ƒêang x·ª≠ l√Ω: ${file.name}`, true);
                try {
                    const id = crypto.randomUUID();
                    const duration = await getAudioDuration(file);

                    const metadata = {
                        id: id,
                        name: file.name.replace(/\.[^/.]+$/, ""),
                        artist: 'Local Upload', 
                        duration: duration,
                    };
                    
                    // 1. Save File/Blob to Local IndexedDB
                    await saveBlobToLocalDB(id, file);

                    // 2. Save Metadata to Cloud Firestore (Public)
                    await saveSongMetadataToCloud(metadata);

                    showStatus(`ƒê√£ l∆∞u metadata l√™n Cloud (C√¥ng c·ªông) v√† file c·ª•c b·ªô: ${file.name}`, false);

                } catch(e) {
                    console.error("File processing failed:", e);
                    showStatus(`L·ªói x·ª≠ l√Ω file ${file.name}: ${e.message}`, false);
                }
            }
        }
        
        async function deleteSong(song) {
            if (!song || !song.id) return;
            
            // Only allow the original uploader (or admin) to delete, but since we are anonymous, 
            // we will just allow anyone with the current userId to delete for simplicity in this sandbox env.
            // In a real app, you'd check if song.uploaderId === userId.

            try {
                showStatus(`ƒêang x√≥a ${song.name}...`, true);
                
                // 1. Delete Metadata from Cloud Firestore (Public)
                await deleteSongMetadataFromCloud(song.id);
                
                // 2. Delete File/Blob from Local IndexedDB
                await deleteBlobFromLocalDB(song.id);
                
                showStatus(`ƒê√£ x√≥a ${song.name} kh·ªèi Cloud v√† thi·∫øt b·ªã n√†y.`, false);
            } catch (e) {
                showStatus(`L·ªói khi x√≥a ${song.name}: ${e.message}`, false);
            }
        }


        sidebarUpload.addEventListener('change', (e) => handleFiles(e.target.files));
        libUploadMain.addEventListener('change', (e) => handleFiles(e.target.files));
        
        const libMain = libraryView;
        libMain.addEventListener('dragover', e=>{ e.preventDefault(); libMain.style.opacity=0.95 });
        libMain.addEventListener('dragleave', e=>{ libMain.style.opacity=1 });
        libMain.addEventListener('drop', e=>{ e.preventDefault(); libMain.style.opacity=1; handleFiles(e.dataTransfer.files) });

        // --- UI Renders ---
        
        function renderSidebarList(){
            sidebarList.innerHTML = '';
            if (songs.length === 0) {
                 sidebarList.innerHTML = '<li><small class="local-ok">Kh√¥ng c√≥ b√†i h√°t n√†o ƒë∆∞·ª£c ƒë·ªìng b·ªô.</small></li>';
                 return;
            }
            songs.forEach((it, idx)=>{
                const isLocal = !!it.file;
                const li = document.createElement('li');
                li.className = isLocal ? '' : 'local-missing';
                const statusClass = isLocal ? 'local-ok' : 'local-missing';

                li.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center"><span>${it.name}</span><small class="${statusClass}">${isLocal ? fmt(it.duration) : 'Thi·∫øu File c·ª•c b·ªô'}</small></div>`;
                
                if (isLocal) {
                    li.onclick = ()=>{ playSong(idx); showView('home'); }
                } else {
                     li.title = "File nh·∫°c kh√¥ng c√≥ tr√™n thi·∫øt b·ªã n√†y.";
                }
                sidebarList.appendChild(li);
            });
        }

        function renderLibrary(){
            libraryGrid.innerHTML='';
            if (songs.length === 0) {
                libraryGrid.innerHTML = '<div class="small-muted" style="text-align:center; padding: 20px;">Kh√¥ng c√≥ b√†i h√°t n√†o tr√™n Cloud. H√£y t·∫£i l√™n m·ªôt b√†i!</div>';
                return;
            }
            songs.forEach((it, idx)=>{
                const isLocal = !!it.file;
                const row = document.createElement('div'); 
                row.className='file-row';
                
                const uploaderInfo = it.uploaderId 
                    ? `T·∫£i l√™n b·ªüi: ${it.uploaderId.substring(0, 8)}...`
                    : 'T·∫£i l√™n b·ªüi: Kh√¥ng r√µ';

                row.innerHTML = `
                    <div>
                        <strong>${it.name}</strong>
                        <div class="small-muted">${uploaderInfo}</div>
                        <div style="font-size: 13px; color: ${isLocal ? 'var(--accent)' : 'var(--warning)'}">${isLocal ? 'ƒê√É C√ì FILE C·ª§C B·ªò' : 'THI·∫æU FILE C·ª§C B·ªò'}</div>
                    </div>
                    <div style="display:flex;gap:8px">
                        <button class='btn ghost' data-idx='${idx}' ${isLocal ? '' : 'disabled'}>Ph√°t</button>
                        <button class='btn danger' data-id='${it.id}'>X√≥a (Cloud & Local)</button>
                    </div>
                `;
                
                const playBtn = row.querySelector('.btn.ghost');
                const deleteBtn = row.querySelector('.btn.danger');
                
                if (isLocal) {
                    playBtn.onclick = ()=>{ playSong(idx); showView('home'); }
                }
                
                if (deleteBtn) {
                    deleteBtn.onclick = () => {
                        deleteSong(it);
                    };
                }
                libraryGrid.appendChild(row);
            });
        }

        function renderPlaylist(){
            playlistContainer.innerHTML='';
            const activeList = songs; 
            
            if(activeList.length===0){ 
                playlistContainer.innerHTML='<div class="small-muted" style="text-align:center; padding: 20px;">Playlist tr·ªëng. T·∫£i l√™n file m·ªõi.</div>'; 
                return 
            }
            
            activeList.forEach((s, i)=>{
                const isLocal = !!s.file;
                const tr = document.createElement('div'); 
                tr.className='track'+(i===currentIndex? ' active':'') + (isLocal ? '' : ' unplayable');
                tr.setAttribute('data-index', i);
                
                const uploaderInfo = s.uploaderId 
                    ? `T·∫£i l√™n b·ªüi: ${s.uploaderId.substring(0, 8)}...`
                    : 'T·∫£i l√™n b·ªüi: Kh√¥ng r√µ';

                tr.innerHTML = `
                    <div class='meta'>
                        <div class='thumb'>‚ô™</div>
                        <div class='info'>
                            <div class='name'>${s.name}</div>
                            <div class='artist'>${uploaderInfo}</div>
                        </div>
                    </div>
                    <div class='small-muted' style="color: ${isLocal ? 'var(--muted)' : 'var(--warning)'}">${isLocal ? fmt(s.duration) : 'Thi·∫øu File'}</div>
                `;
                
                if (isLocal) {
                    tr.onclick = ()=>{ playSong(i); }
                } else {
                    tr.title = "Kh√¥ng th·ªÉ ph√°t: File nh·∫°c kh√¥ng c√≥ tr√™n thi·∫øt b·ªã n√†y.";
                }
                playlistContainer.appendChild(tr);
            });
        }
        
        // --- Player Logic ---

        function loadSong(i){
            if(i === -1 || !songs[i] || !songs[i].file) {
                currentIndex = -1;
                if (currentObjectURL) URL.revokeObjectURL(currentObjectURL);
                audio.src = '';
                currentTitle.innerText = 'Kh√¥ng c√≥ b√†i';
                timeRight.innerText = '0:00';
                timeLeft.innerText = '0:00';
                seek.value = 0;
                Array.from(document.querySelectorAll('.track')).forEach(el => el.classList.remove('active'));
                return;
            }
            
            currentIndex = i;
            const song = songs[i];
            
            if (currentObjectURL) URL.revokeObjectURL(currentObjectURL);
            
            currentObjectURL = URL.createObjectURL(song.file);
            audio.src = currentObjectURL; 
            
            currentTitle.innerText = song.name;
            
            Array.from(document.querySelectorAll('.track')).forEach((el,idx)=>{
                el.classList.toggle('active', idx===i);
            });
            timeRight.innerText = fmt(song.duration);
        }

        function playSong(i){ 
            if (i >= 0 && i < songs.length && songs[i].file) {
                loadSong(i); 
                audio.play(); 
                playBtn.innerText='‚è∏'; 
            } else {
                console.error("Cannot play song: File not available locally.");
            }
        }

        // --- Player Controls ---
        
        playBtn.onclick = ()=>{
            if(audio.src === '' || currentIndex === -1) {
                if (songs.length > 0) {
                    // Try to find the first playable song
                    const firstPlayableIndex = songs.findIndex(s => s.file);
                    if (firstPlayableIndex !== -1) {
                        playSong(firstPlayableIndex);
                    }
                }
                return;
            }
            if(audio.paused){ 
                audio.play(); playBtn.innerText='‚è∏'; 
            } else { 
                audio.pause(); playBtn.innerText='‚ñ∂'; 
            }
        }
        
        prevBtn.onclick = ()=>{
            if(songs.length===0) return;
            // Find the previous playable song index
            let newIndex = currentIndex;
            do {
                newIndex = (newIndex - 1 + songs.length) % songs.length;
                if (songs[newIndex].file || newIndex === currentIndex) {
                    playSong(newIndex);
                    return;
                }
            } while (newIndex !== currentIndex);
        }
        
        nextBtn.onclick = ()=>{
            if(songs.length===0) return;
            // Find the next playable song index
            let newIndex = currentIndex;
            do {
                newIndex = (newIndex + 1) % songs.length;
                if (songs[newIndex].file || newIndex === currentIndex) {
                    playSong(newIndex);
                    return;
                }
            } while (newIndex !== currentIndex);
        }
        
        repeatBtn.onclick = ()=>{ 
            repeat = !repeat; 
            repeatBtn.style.color = repeat? 'var(--accent)':'#ddd'; 
        }

        volume.oninput = ()=>{ audio.volume = volume.value }

        audio.ontimeupdate = ()=>{
            if(isNaN(audio.duration) || audio.duration <= 0) return;
            const pct = (audio.currentTime/audio.duration)*100; 
            seek.value = pct; 
            timeLeft.innerText = fmt(audio.currentTime); 
        }
        
        seek.oninput = ()=>{
            if(isNaN(audio.duration) || audio.duration <= 0) return; 
            audio.currentTime = (seek.value/100)*audio.duration;
        }

        audio.onended = ()=>{
            if (currentObjectURL) {
                URL.revokeObjectURL(currentObjectURL);
                currentObjectURL = null;
            }
            
            if(repeat){ 
                audio.currentTime = 0; 
                audio.play(); 
                return 
            }
            
            if(songs.length===0) return;
            
            // Find next playable song
            let nextIndex = currentIndex;
            do {
                nextIndex = (nextIndex + 1) % songs.length;
                if (songs[nextIndex].file) {
                    playSong(nextIndex);
                    return;
                }
                // Stop if we looped back to the current song and it's not playable (or currentIndex is -1)
            } while (nextIndex !== currentIndex && currentIndex !== -1);
            
            loadSong(-1); 
        }

        // --- Navigation ---
        
        navHome.onclick = () => { showView('home'); }
        navLibrary.onclick = () => { showView('library'); }

        function showView(name){
            document.querySelector('.title').innerText = name === 'home' ? 'Playlist' : 'Th∆∞ vi·ªán';
            homeView.style.display = name === 'home' ? 'block' : 'none';
            libraryView.style.display = name === 'library' ? 'block' : 'none';
            navHome.classList.toggle('active', name === 'home'); 
            navLibrary.classList.toggle('active', name === 'library');
        }

        // --- Initial Load & Auth ---
        async function initAuth() {
            showStatus("ƒêang x√°c th·ª±c Firebase...", true);
            
            await openLocalDB(); // Open local IndexedDB regardless of auth state
            
            // Firebase Auth
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    isAuthReady = true;
                    authUserId.innerText = `User ID c·ªßa b·∫°n: ${userId.substring(0, 8)}... (Ng∆∞·ªùi t·∫£i l√™n)`;
                    authStatus.innerText = 'ƒê√É K·∫æT N·ªêI (Cloud Sync Public)';
                    
                    showStatus("ƒê√£ x√°c th·ª±c. ƒêang t·∫£i d·ªØ li·ªáu...", false);
                    loadingIndicatorHome.innerText = 'ƒêang t·∫£i danh s√°ch b√†i h√°t c√¥ng c·ªông t·ª´ Cloud...';
                    
                    setupFirestoreListener(); // Start listening to public cloud data
                } else {
                    // Sign in anonymously if not already authenticated
                    try {
                        const token = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                        if (token) {
                            await signInWithCustomToken(auth, token);
                        } else {
                            await signInAnonymously(auth);
                        }
                    } catch(e) {
                        console.error("Firebase Sign In Error:", e);
                        isAuthReady = true;
                        authStatus.innerText = 'L·ªñI X√ÅC TH·ª∞C (Ch·ªâ d√πng Local)';
                        authUserId.innerText = 'Kh√¥ng th·ªÉ k·∫øt n·ªëi Cloud.';
                        loadingIndicatorHome.innerText = 'Kh√¥ng th·ªÉ t·∫£i Cloud Data. Vui l√≤ng t·∫£i file c·ª•c b·ªô.';
                    }
                }
            });
            showView('home');
        }
        
        window.onload = initAuth;
    </script>
</body>
</html>
