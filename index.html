<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Trinity - Tr√¨nh ph√°t nh·∫°c Cloud Storage</title>
    <style>
        :root{
            --bg:#121212;--panel:#181818;--muted:#9a9a9a;--accent:#1db954;--card:#1e1e1e;--warning:#ffcc00
        }
        *{box-sizing:border-box}
        html,body{height:100%;margin:0;font-family:Inter,Arial,Helvetica,sans-serif;background:var(--bg);color:#eee}

        .app{display:flex;height:100vh;}
        .sidebar{width:240px;background:#0f0f0f;padding:22px;border-right:1px solid #222;display:flex;flex-direction:column}
        .brand{font-weight:700;font-size:18px;margin-bottom:18px;color:var(--accent)}
        .nav{display:flex;flex-direction:column;gap:8px}
        .nav button{background:transparent;border:none;color:#ddd;text-align:left;padding:10px;border-radius:8px;cursor:pointer;font-size:15px}
        .nav button.active{background:#171717}

        .library-box{margin-top:18px;padding-top:12px;border-top:1px solid #212121}
        .upload-label{display:inline-block;padding:10px 12px;background:#111;border-radius:10px;cursor:pointer;border:1px dashed #2a2a2a; transition: all 0.2s;}
        .upload-label:hover{border-color:var(--accent); background: #1a1a1a;}
        .upload-input{display:none}
        .library-list{margin-top:12px;max-height:38vh;overflow:auto;padding:0;list-style:none}
        .library-list li{padding:8px;border-radius:8px;background:#121212;margin-bottom:8px;border:1px solid #222;cursor:pointer; transition: background 0.2s;}
        .library-list li:hover{background:#1a1a1a;}
        .library-list li small{display:block;font-size:12px}
        .library-list li small.local-ok{color:var(--muted);}

        .main{flex:1;display:flex;flex-direction:column}
        .topbar{padding:18px 24px;border-bottom:1px solid #242424;display:flex;justify-content:space-between;align-items:center}
        .title{font-size:20px}
        .auth-info{font-size:12px; color: var(--muted); padding-right: 10px;}

        .content{flex:1;overflow:auto;padding:22px}

        .playlist{max-width:900px;margin:0 auto;display:flex;flex-direction:column;gap:12px}
        .track{display:flex;justify-content:space-between;align-items:center;padding:12px;border-radius:10px;background:var(--card);border:1px solid #252525; cursor:pointer; transition: background 0.2s;}
        .track:hover{background: #252525;}
        .track .meta{display:flex;gap:12px;align-items:center}
        .track .meta .thumb{width:48px;height:48px;border-radius:6px;background:linear-gradient(135deg,#222,#111);display:flex;align-items:center;justify-content:center;color:var(--muted)}
        .track .meta .info{display:flex;flex-direction:column}
        .track .meta .info .name{font-weight:600}
        .track .meta .info .artist{font-size:13px;color:var(--muted)}
        .track.active{outline:2px solid var(--accent); background: #222222;}

        .volume{width:120px;}
        .player-bar{height:110px;background:var(--panel);border-top:1px solid #252525;padding:14px 22px;display:flex;align-items:center;gap:18px}
        .player-cover{width:70px;height:70px;border-radius:8px;background:#161616;display:flex;align-items:center;justify-content:center}
        .player-controls{flex:1}
        .controls{display:flex;align-items:center;gap:14px;margin-bottom:8px}
        .controls button{background:transparent;border:none;color:#ddd;font-size:24px;cursor:pointer; transition: color 0.2s; padding: 4px; border-radius: 4px;}
        .controls button:hover{color: var(--accent);}
        .seek{width:100%; height: 6px; cursor: pointer;}
        .small-muted{color:var(--muted);font-size:13px}

        .library-main{max-width:900px;margin:0 auto}
        .library-grid{display:flex;flex-direction:column;gap:10px;margin-top:12px}
        .file-row{display:flex;justify-content:space-between;align-items:center;padding:12px;border-radius:10px;background:#151515;border:1px solid #232323}
        .btn{padding:8px 12px;border-radius:8px;border:none;cursor:pointer;font-weight: 500;}
        .btn.ghost{background:transparent;border:1px solid #333;color:#ddd; transition: all 0.2s;}
        .btn.ghost:hover{background: #333;}
        .btn.primary{background:var(--accent);color:#061d0d; transition: all 0.2s;}
        .btn.primary:hover{background: #159544;}
        .btn.danger{background: #b91d1d; color: white;}
        .btn:disabled{opacity: 0.5; cursor: not-allowed;}

        .status-box{
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 20px 30px;
            border-radius: 12px;
            z-index: 1000;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid var(--accent);
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin-bottom: 10px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media(max-width:880px){
            .sidebar{display:none}
            .app{flex-direction:column}
            .player-bar{height:90px; padding: 10px 15px;}
            .player-cover{width: 50px; height: 50px;}
            .auth-info{display: none;}
            .volume{display: none;}
            .controls{gap: 10px;}
            .controls button{font-size: 20px;}
        }
    </style>
</head>
<body>
    <div class="app">
        <aside class="sidebar">
            <div class="brand">üéß MusicApp (Cloud Storage)</div>
            <nav class="nav">
                <button id="navHome" class="active">Playlist (C√¥ng c·ªông)</button>
                <button id="navLibrary">Th∆∞ vi·ªán (Qu·∫£n l√Ω File)</button>
            </nav>

            <div class="library-box">
                <label class="upload-label">T·∫£i file m·ªõi (L∆∞u Cloud Storage & Metadata)
                    <input id="sidebarUpload" class="upload-input" type="file" accept="audio/*" multiple />
                </label>
                <ul id="sidebarList" class="library-list"></ul>
            </div>
            
            <div style="margin-top: auto; padding-top: 15px; border-top: 1px solid #212121;">
                 <div id="authUserId" class="small-muted" style="word-break: break-all;"></div>
            </div>
        </aside>

        <main class="main">
            <div class="topbar">
                <div class="title">Home</div>
                <div id="authStatus" class="auth-info">ƒêang k·∫øt n·ªëi...</div>
            </div>

            <div class="content">
                <section id="homeView" class="home-view">
                    <h2>Danh s√°ch b√†i h√°t ƒë∆∞·ª£c chia s·∫ª c√¥ng c·ªông (Public Playlist)</h2>
                    <div class="small-muted" style="color: var(--accent);">
                        TO√ÄN B·ªò FILE ƒê∆Ø·ª¢C L∆ØU TR√äN CLOUD STORAGE V√Ä C√ì TH·ªÇ PH√ÅT T·ª™ M·ªåI THI·∫æT B·ªä.
                    </div>
                    <div class="playlist" id="playlistContainer">
                        <div class="small-muted" id="loadingIndicatorHome">ƒêang ch·ªù x√°c th·ª±c Firebase...</div>
                    </div>
                </section>

                <section id="libraryView" class="library-main" style="display:none">
                    <h3>Qu·∫£n l√Ω Th∆∞ vi·ªán - Metadata ƒë∆∞·ª£c l∆∞u tr√™n Cloud (C√¥ng c·ªông)</h3>
                    <div style="margin-top:14px">
                        <label class="upload-label">T·∫£i file m·ªõi<input id="libUploadMain" class="upload-input" type="file" accept="audio/*" multiple /></label>
                    </div>
                    <div class="library-grid" id="libraryGrid"></div>
                </section>
            </div>

            <div class="player-bar">
                <div class="player-cover" id="playerCover">‚ô™</div>
                <div class="player-controls">
                    <div class="controls">
                        <input id="volume" class="volume" type="range" min="0" max="1" step="0.01" value="1">
                        <button id="prevBtn" title="Previous">‚èÆ</button>
                        <button id="playBtn" title="Play/Pause">‚ñ∂</button>
                        <button id="nextBtn" title="Next">‚è≠</button>
                        <button id="repeatBtn" title="Repeat Playlist">üîÅ</button>
                        <div id="currentTitle" style="margin-left:10px;font-weight:600">Kh√¥ng c√≥ b√†i</div>
                    </div>
                    <input id="seek" class="seek" type="range" min="0" max="100" value="0">
                    <div style="display:flex;justify-content:space-between;margin-top:6px"><span id="timeLeft" class="small-muted">0:00</span><span id="timeRight" class="small-muted">0:00</span></div>
                </div>
                <audio id="audioPlayer" preload="metadata" style="display:none"></audio>
            </div>
        </main>
    </div>

    <div id="statusBox" class="status-box">
        <div class="spinner"></div>
        <div id="statusText">ƒêang x·ª≠ l√Ω...</div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, collection, setDoc, deleteDoc, onSnapshot, query, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

        // --- Firebase Globals and Setup ---
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-music-app-id';

        let app;
        let db;
        let auth;
        let storage;
        let userId = null;
        let isAuthReady = false;
        
        // Check config and initialize services
        if (Object.keys(firebaseConfig).length > 0) {
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                storage = getStorage(app); 
                setLogLevel('debug'); // Set log level to debug for detailed output
            } catch (e) {
                console.error("L·ªñI KH·ªûI T·∫†O FIREBASE: ", e);
                // Services will remain undefined if initialization fails
            }
        } else {
            console.error("L·ªñI C·∫§U H√åNH: Firebase config is missing. Services not initialized.");
            document.getElementById('authStatus').innerText = 'L·ªñI C·∫§U H√åNH (Kh√¥ng c√≥ Config)';
            document.getElementById('loadingIndicatorHome').innerText = 'Vui l√≤ng ki·ªÉm tra l·∫°i c·∫•u h√¨nh Firebase.';
            document.getElementById('authUserId').innerText = 'Kh√¥ng th·ªÉ k·∫øt n·ªëi Cloud.';
        }

        // Public collection path for shared metadata
        const PUBLIC_SONGS_COLLECTION_PATH = `artifacts/${appId}/public/data/songs_public`;
        const getSongsCollectionPath = () => PUBLIC_SONGS_COLLECTION_PATH;
        
        // Storage path for public files
        const PUBLIC_STORAGE_PATH = `artifacts/${appId}/public/files/music`;

        // --- App State and Elements ---
        let songs = []; 
        let currentIndex = -1;
        let repeat = false;
        
        const navHome = document.getElementById('navHome');
        const navLibrary = document.getElementById('navLibrary');
        const homeView = document.getElementById('homeView');
        const libraryView = document.getElementById('libraryView');
        const sidebarUpload = document.getElementById('sidebarUpload');
        const sidebarList = document.getElementById('sidebarList');
        const libUploadMain = document.getElementById('libUploadMain');
        const libraryGrid = document.getElementById('libraryGrid');
        const playlistContainer = document.getElementById('playlistContainer');
        const loadingIndicatorHome = document.getElementById('loadingIndicatorHome');
        const authUserId = document.getElementById('authUserId');
        const authStatus = document.getElementById('authStatus');
        
        const audio = document.getElementById('audioPlayer');
        const playBtn = document.getElementById('playBtn');
        const prevBtn = document.getElementById('prevBtn');
        const nextBtn = document.getElementById('nextBtn');
        const repeatBtn = document.getElementById('repeatBtn');
        const currentTitle = document.getElementById('currentTitle');
        const seek = document.getElementById('seek');
        const timeLeft = document.getElementById('timeLeft');
        const timeRight = document.getElementById('timeRight');
        const statusBox = document.getElementById('statusBox');
        const statusText = document.getElementById('statusText');
        const volume = document.getElementById('volume');

        // --- Utility Functions ---

        function fmt(s){
            if(isNaN(s) || s < 0) return '0:00';
            const m = Math.floor(s/60); 
            const sec = Math.floor(s%60).toString().padStart(2,'0');
            return m+':'+sec;
        }

        function showStatus(text, show) {
            statusText.innerText = text;
            statusBox.style.display = show ? 'flex' : 'none';
        }

        function getAudioDuration(file) {
            return new Promise((resolve, reject) => {
                const tempAudio = document.createElement('audio');
                tempAudio.preload = 'metadata';
                const tempURL = URL.createObjectURL(file);
                
                tempAudio.onloadedmetadata = () => {
                    resolve(tempAudio.duration);
                    URL.revokeObjectURL(tempURL);
                };
                tempAudio.onerror = (e) => {
                    console.error("Failed to load audio metadata.", e);
                    URL.revokeObjectURL(tempURL);
                    resolve(0);
                };
                tempAudio.src = tempURL;
            });
        }
        
        // --- Firebase Storage and Firestore Functions (Guarded) ---

        async function saveSongMetadataToCloud(metadata) {
            if (!userId || !db) throw new Error("Cloud features not ready.");
            
            const songsRef = collection(db, getSongsCollectionPath()); 
            
            await setDoc(doc(songsRef, metadata.id), {
                id: metadata.id,
                name: metadata.name,
                artist: metadata.artist,
                duration: metadata.duration,
                downloadURL: metadata.downloadURL, 
                storagePath: metadata.storagePath, 
                timestamp: Date.now(),
                uploaderId: userId 
            });
        }

        async function deleteSongMetadataFromCloud(id) {
            if (!userId || !db) throw new Error("Cloud features not ready.");
            
            const docRef = doc(db, getSongsCollectionPath(), id);
            await deleteDoc(docRef);
        }
        
        async function deleteSongFileFromStorage(storagePath) {
             if (!storagePath || !storage) return;
             
             const fileRef = ref(storage, storagePath);
             await deleteObject(fileRef);
        }
        
        function setupFirestoreListener() {
            if (!isAuthReady || !db) return; // Guard clause
            
            loadingIndicatorHome.innerText = 'ƒêang t·∫£i danh s√°ch b√†i h√°t c√¥ng c·ªông t·ª´ Cloud...';
            
            const q = query(collection(db, getSongsCollectionPath())); 
            
            onSnapshot(q, async (snapshot) => {
                loadingIndicatorHome.style.display = 'none';
                
                songs = snapshot.docs.map(d => d.data());
                
                renderLibrary();
                renderSidebarList();
                renderPlaylist();
                
                if (currentIndex !== -1 && (!songs[currentIndex] || songs[currentIndex].id !== songs[currentIndex].id)) {
                    if (songs.length > 0) {
                        loadSong(0);
                        audio.pause();
                    } else {
                        loadSong(-1);
                    }
                }
            }, (error) => {
                console.error("Firestore Listener Error:", error);
                authStatus.innerText = 'L·ªói ƒë·ªìng b·ªô Cloud.';
            });
        }

        // --- File Management & Upload ---

        async function handleFiles(fileList){
            if (!userId || !db || !storage) {
                console.error("Cloud features not ready. Cannot upload.");
                showStatus("L·ªói: Cloud ch∆∞a s·∫µn s√†ng ƒë·ªÉ t·∫£i l√™n (Ki·ªÉm tra Console).", false);
                return;
            }
            if (fileList.length === 0) return;

            loadingIndicatorHome.style.display = 'none';

            for(const file of fileList){
                showStatus(`ƒêang x·ª≠ l√Ω: ${file.name} (T·∫£i l√™n Storage...)`, true);
                try {
                    const id = crypto.randomUUID();
                    const duration = await getAudioDuration(file);
                    
                    const storagePath = `${PUBLIC_STORAGE_PATH}/${id}/${file.name}`;
                    const fileRef = ref(storage, storagePath);
                    const uploadResult = await uploadBytes(fileRef, file);
                    
                    const downloadURL = await getDownloadURL(uploadResult.ref);

                    const metadata = {
                        id: id,
                        name: file.name.replace(/\.[^/.]+$/, ""),
                        artist: 'Cloud Upload', 
                        duration: duration,
                        downloadURL: downloadURL,
                        storagePath: storagePath
                    };
                    
                    await saveSongMetadataToCloud(metadata);

                    showStatus(`ƒê√£ t·∫£i file l√™n Cloud Storage v√† l∆∞u metadata l√™n Cloud Firestore: ${file.name}`, false);

                } catch(e) {
                    console.error("File processing failed:", e);
                    showStatus(`L·ªói x·ª≠ l√Ω file ${file.name}: ${e.message}`, false);
                }
            }
        }
        
        async function deleteSong(song) {
            if (!song || !song.id || !db || !storage) return;
            
            try {
                showStatus(`ƒêang x√≥a ${song.name} kh·ªèi Storage v√† Cloud...`, true);
                
                await deleteSongFileFromStorage(song.storagePath);
                await deleteSongMetadataFromCloud(song.id);
                
                showStatus(`ƒê√£ x√≥a ${song.name} ho√†n to√†n kh·ªèi Cloud.`, false);
            } catch (e) {
                showStatus(`L·ªói khi x√≥a ${song.name}: ${e.message}`, false);
            }
        }


        sidebarUpload.addEventListener('change', (e) => handleFiles(e.target.files));
        libUploadMain.addEventListener('change', (e) => handleFiles(e.target.files));
        
        const libMain = libraryView;
        libMain.addEventListener('dragover', e=>{ e.preventDefault(); libMain.style.opacity=0.95 });
        libMain.addEventListener('dragleave', e=>{ libMain.style.opacity=1 });
        libMain.addEventListener('drop', e=>{ e.preventDefault(); libMain.style.opacity=1; handleFiles(e.dataTransfer.files) });

        // --- UI Renders (same as before) ---
        
        function renderSidebarList(){
            sidebarList.innerHTML = '';
            if (songs.length === 0) {
                 sidebarList.innerHTML = '<li><small class="local-ok">Kh√¥ng c√≥ b√†i h√°t n√†o ƒë∆∞·ª£c ƒë·ªìng b·ªô.</small></li>';
                 return;
            }
            songs.forEach((it, idx)=>{
                const li = document.createElement('li');
                li.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center"><span>${it.name}</span><small class="local-ok">${fmt(it.duration)}</small></div>`;
                li.onclick = ()=>{ playSong(idx); showView('home'); }
                sidebarList.appendChild(li);
            });
        }

        function renderLibrary(){
            libraryGrid.innerHTML='';
            if (songs.length === 0) {
                libraryGrid.innerHTML = '<div class="small-muted" style="text-align:center; padding: 20px;">Kh√¥ng c√≥ b√†i h√°t n√†o tr√™n Cloud. H√£y t·∫£i l√™n m·ªôt b√†i!</div>';
                return;
            }
            songs.forEach((it, idx)=>{
                const row = document.createElement('div'); 
                row.className='file-row';
                
                const uploaderInfo = it.uploaderId 
                    ? `T·∫£i l√™n b·ªüi: ${it.uploaderId.substring(0, 8)}...`
                    : 'T·∫£i l√™n b·ªüi: Kh√¥ng r√µ';
                    
                const isUploader = it.uploaderId === userId;

                row.innerHTML = `
                    <div>
                        <strong>${it.name}</strong>
                        <div class="small-muted">${uploaderInfo}</div>
                        <div style="font-size: 13px; color: var(--accent);">ƒê√É L∆ØU TR√äN CLOUD STORAGE</div>
                    </div>
                    <div style="display:flex;gap:8px">
                        <button class='btn ghost' data-idx='${idx}'>Ph√°t</button>
                        <button class='btn danger' data-id='${it.id}' ${isUploader ? '' : 'disabled'} title="${isUploader ? 'X√≥a file kh·ªèi Cloud Storage v√† Metadata' : 'Ch·ªâ ng∆∞·ªùi t·∫£i l√™n m·ªõi ƒë∆∞·ª£c x√≥a'}">X√≥a</button>
                    </div>
                `;
                
                const playBtn = row.querySelector('.btn.ghost');
                const deleteBtn = row.querySelector('.btn.danger');
                
                playBtn.onclick = ()=>{ playSong(idx); showView('home'); }
                
                if (isUploader && deleteBtn) {
                    deleteBtn.onclick = () => {
                        deleteSong(it);
                    };
                }
                libraryGrid.appendChild(row);
            });
        }

        function renderPlaylist(){
            playlistContainer.innerHTML='';
            const activeList = songs; 
            
            if(activeList.length===0){ 
                playlistContainer.innerHTML='<div class="small-muted" style="text-align:center; padding: 20px;">Playlist tr·ªëng. T·∫£i l√™n file m·ªõi.</div>'; 
                return 
            }
            
            activeList.forEach((s, i)=>{
                const tr = document.createElement('div'); 
                tr.className='track'+(i===currentIndex? ' active':'');
                tr.setAttribute('data-index', i);
                
                const uploaderInfo = s.uploaderId 
                    ? `T·∫£i l√™n b·ªüi: ${s.uploaderId.substring(0, 8)}...`
                    : 'T·∫£i l√™n b·ªüi: Kh√¥ng r√µ';

                tr.innerHTML = `
                    <div class='meta'>
                        <div class='thumb'>‚ô™</div>
                        <div class='info'>
                            <div class='name'>${s.name}</div>
                            <div class='artist'>${uploaderInfo}</div>
                        </div>
                    </div>
                    <div class='small-muted'>${fmt(s.duration)}</div>
                `;
                
                tr.onclick = ()=>{ playSong(i); }
                playlistContainer.appendChild(tr);
            });
        }
        
        // --- Player Logic (same as before) ---

        function loadSong(i){
            if(i === -1 || !songs[i] || !songs[i].downloadURL) {
                currentIndex = -1;
                audio.src = '';
                currentTitle.innerText = 'Kh√¥ng c√≥ b√†i';
                timeRight.innerText = '0:00';
                timeLeft.innerText = '0:00';
                seek.value = 0;
                Array.from(document.querySelectorAll('.track')).forEach(el => el.classList.remove('active'));
                return;
            }
            
            currentIndex = i;
            const song = songs[i];
            
            audio.src = song.downloadURL; 
            
            currentTitle.innerText = song.name;
            
            Array.from(document.querySelectorAll('.track')).forEach((el,idx)=>{
                el.classList.toggle('active', idx===i);
            });
            timeRight.innerText = fmt(song.duration);
        }

        function playSong(i){ 
            if (i >= 0 && i < songs.length && songs[i].downloadURL) {
                loadSong(i); 
                audio.play(); 
                playBtn.innerText='‚è∏'; 
            } else {
                console.error("Cannot play song: Download URL is missing.");
            }
        }

        // --- Player Controls (same as before) ---
        
        playBtn.onclick = ()=>{
            if(audio.src === '' || currentIndex === -1) {
                if (songs.length > 0) {
                    playSong(0); 
                }
                return;
            }
            if(audio.paused){ 
                audio.play(); playBtn.innerText='‚è∏'; 
            } else { 
                audio.pause(); playBtn.innerText='‚ñ∂'; 
            }
        }
        
        prevBtn.onclick = ()=>{
            if(songs.length===0) return;
            const newIndex = (currentIndex - 1 + songs.length) % songs.length;
            playSong(newIndex);
        }
        
        nextBtn.onclick = ()=>{
            if(songs.length===0) return;
            const newIndex = (currentIndex + 1) % songs.length;
            playSong(newIndex);
        }
        
        repeatBtn.onclick = ()=>{ 
            repeat = !repeat; 
            repeatBtn.style.color = repeat? 'var(--accent)':'#ddd'; 
        }

        volume.oninput = ()=>{ audio.volume = volume.value }

        audio.ontimeupdate = ()=>{
            if(isNaN(audio.duration) || audio.duration <= 0) return;
            const pct = (audio.currentTime/audio.duration)*100; 
            seek.value = pct; 
            timeLeft.innerText = fmt(audio.currentTime); 
        }
        
        seek.oninput = ()=>{
            if(isNaN(audio.duration) || audio.duration <= 0) return; 
            audio.currentTime = (seek.value/100)*audio.duration;
        }

        audio.onended = ()=>{
            if(repeat){ 
                audio.currentTime = 0; 
                audio.play(); 
                return 
            }
            
            if(songs.length===0) return;
            
            let nextIndex = (currentIndex + 1) % songs.length;
            playSong(nextIndex);
        }

        // --- Navigation (same as before) ---
        
        navHome.onclick = () => { showView('home'); }
        navLibrary.onclick = () => { showView('library'); }

        function showView(name){
            document.querySelector('.title').innerText = name === 'home' ? 'Playlist' : 'Th∆∞ vi·ªán';
            homeView.style.display = name === 'home' ? 'block' : 'none';
            libraryView.style.display = name === 'library' ? 'block' : 'none';
            navHome.classList.toggle('active', name === 'home'); 
            navLibrary.classList.toggle('active', name === 'library');
        }

        // --- Initial Load & Auth (Fixed) ---
        async function initAuth() {
            // Check if Firebase services were initialized successfully
            if (!auth) {
                authStatus.innerText = 'KH√îNG C√ì CLOUD (Check Console)';
                authUserId.innerText = '·ª®ng d·ª•ng ch·∫°y ·ªü ch·∫ø ƒë·ªô ch·ªâ ƒë·ªçc.';
                loadingIndicatorHome.innerText = 'Kh√¥ng th·ªÉ t·∫£i Cloud Data (Thi·∫øu Firebase Config).';
                showStatus("L·ªói: Kh√¥ng t√¨m th·∫•y c·∫•u h√¨nh Firebase. Ch·ªâ ch·∫°y giao di·ªán.", false);
                return;
            }

            showStatus("ƒêang x√°c th·ª±c Firebase...", true);
            
            // Firebase Auth
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    isAuthReady = true;
                    authUserId.innerText = `User ID c·ªßa b·∫°n: ${userId.substring(0, 8)}... (Ng∆∞·ªùi t·∫£i l√™n)`;
                    authStatus.innerText = 'ƒê√É K·∫æT N·ªêI (Cloud Sync Public)';
                    
                    showStatus("ƒê√£ x√°c th·ª±c. ƒêang t·∫£i d·ªØ li·ªáu...", false);
                    loadingIndicatorHome.innerText = 'ƒêang t·∫£i danh s√°ch b√†i h√°t c√¥ng c·ªông t·ª´ Cloud...';
                    
                    setupFirestoreListener(); // Start listening to public cloud data
                } else {
                    // Sign in anonymously if not already authenticated
                    try {
                        const token = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                        if (token) {
                            await signInWithCustomToken(auth, token);
                            console.log("Authentication successful with custom token.");
                        } else {
                            await signInAnonymously(auth);
                            console.log("Authentication successful anonymously.");
                        }
                    } catch(e) {
                        console.error("Firebase Sign In Error:", e);
                        isAuthReady = true;
                        authStatus.innerText = 'L·ªñI X√ÅC TH·ª∞C (Vui l√≤ng ki·ªÉm tra Console)';
                        authUserId.innerText = `L·ªói: ${e.code}`;
                        loadingIndicatorHome.innerText = 'Kh√¥ng th·ªÉ t·∫£i Cloud Data.';
                        showStatus(`L·ªói x√°c th·ª±c: ${e.code}`, false); 
                    }
                }
            });
            showView('home');
        }
        
        window.onload = initAuth;
    </script>
</body>
</html>
